在虚拟化、并发之后，就是负责持久化的FS了。
通常来说，本地系统使用2PC（2步确认）即可，第一步写入日志，第二步写入数据。
分布式系统有时会使用到3PC（中间加入一步数据的确认，形成共识）。

> [!NOTE] 比较重要的问题
> 1.需要on-disk元数据来保存类Unix风格的目录树和文件。
> 2.支持崩溃恢复（及其一系列不一致问题）。
> 3.串行化并行数据修改。
> 4.通过内存缓存机制来进行IO加速。

#总览 
> [!NOTE] 各层功能
> ![[Pasted image 20240918142108.png]]
> 1.磁盘层负责读写虚拟硬盘上的块。
> 2.缓存层负责内存进程对块的一对一同步读写。
> 3.日志层负责事务的实现（对系列写操作的元数据进行原子打包）。
> 4.INode层负责处理文件和目录的元数据。
> 5.目录层负责根据目录结构管理INode。
> 6.路径层负责递归解析路径string。
> 7.fd层负责抽象统一地处理设备、文件、管道等描述符文件。



#磁盘层 
xv6主要通过qemu模拟硬盘进行读写。

#缓存层
任务：
1.负责内核进程内存和指定磁盘区域的数据映射和同步。
2.缓存经常访问的磁盘数据块。

xv6中使用双向链表来保存缓存块，刚读写过的MFU更新在前边，LRU在后边。
在查找缓存时先从前边找一遍（查设备编号和分区号是否对应），如果没有，再从后边找一遍（找refcnt为0的缓存块，更新元数据并且将valid置0）。

#日志层
日志是数据写的元数据，其crash的几率非常小，在crash后可以重新进行日志中的操作来保证一致性；
如果日志写时crash了，那么需要事件日志或者存档点等技术，不在此文讨论范围。
xv6采取的方法比较简单：在没有完成数据commit前，先commit log（系统调用），数据commit后删除log。

> [!NOTE] 日志的设计
> ![[Pasted image 20240918143145.png]]
> 日志保存在superblock中。
